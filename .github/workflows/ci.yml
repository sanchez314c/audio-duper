name: ðŸŽµ AudioDUPER CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Lint and Code Quality
  lint:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Check code formatting
      run: npm run format:check || true

    - name: Run type checking (if applicable)
      run: npm run type-check || true

  # Test Suite
  test:
    name: ðŸ§ª Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16, 18, 20]
        exclude:
          # Reduce matrix size for CI efficiency
          - os: windows-latest
            node-version: 16
          - os: macos-latest
            node-version: 16

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

    - name: Run coverage
      run: npm run test:coverage || true

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '18'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: false

  # Build Test
  build:
    name: ðŸ—ï¸ Build Test
    runs-on: ${{ matrix.os }}
    needs: [lint, test]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-${{ matrix.os }}
        path: dist/
        retention-days: 7

  # Security Audit
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level moderate

    - name: Run dependency check
      run: npm run bloat-check

  # Bloat Analysis
  bloat:
    name: ðŸ“Š Bloat Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run bloat analysis
      run: npm run bloat-check

    - name: Check bundle size
      run: |
        if [ -d "dist" ]; then
          echo "## Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          du -sh dist/* | while read size file; do
            echo "- $file: $size" >> $GITHUB_STEP_SUMMARY
          done
        fi

  # Release (only on tags)
  release:
    name: ðŸš€ Release
    runs-on: ${{ matrix.os }}
    needs: [lint, test, security]
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build and package
      run: npm run dist:all

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Documentation Build
  docs:
    name: ðŸ“š Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check documentation links
      run: |
        find docs/ -name "*.md" -exec echo "Checking {}" \;
        # Add markdown link checking here if needed

    - name: Validate documentation structure
      run: |
        if [ ! -f "README.md" ]; then
          echo "âŒ README.md missing"
          exit 1
        fi
        if [ ! -f "docs/DEVELOPMENT.md" ]; then
          echo "âŒ DEVELOPMENT.md missing"
          exit 1
        fi
        echo "âœ… Documentation structure validated"

  # Performance Test
  performance:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Performance benchmark
      run: |
        echo "## Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "### Build Time" >> $GITHUB_STEP_SUMMARY
        time npm run build

    - name: Memory usage test
      run: |
        echo "### Memory Usage" >> $GITHUB_STEP_SUMMARY
        npm start &
        sleep 10
        ps aux | grep -i electron | head -5 >> $GITHUB_STEP_SUMMARY || true
        pkill -f electron || true